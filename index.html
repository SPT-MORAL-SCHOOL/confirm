<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° - ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .gradient-bg {
            background: #ffffff; 
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease-in-out;
        }
        .notification.show {
            transform: translateX(0);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div id="notification" class="notification">
        <div class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
            <div class="flex items-center">
                <span id="notificationText">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</span>
                <button onclick="hideNotification()" class="ml-4 text-white hover:text-gray-200">
                    ‚úï
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <div class="glass-effect rounded-3xl p-8 shadow-2xl animate-fade-in">
                <img src="https://img5.pic.in.th/file/secure-sv1/IMG_25650953161d1c1bbdd8.jpeg" 
                     alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á" 
                     class="w-24 h-24 mx-auto mb-4 rounded-full shadow-lg"
                     onerror="this.src=''; this.alt='‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'; this.style.display='none';">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h1>
                <p class="text-lg text-gray-600">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏° ‡∏™‡∏û‡∏ê. ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á</p>
            </div>
        </header>

        <main class="max-w-4xl mx-auto">
            <div id="studentForm" class="glass-effect rounded-3xl p-8 shadow-2xl mb-8 animate-fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h2>
                
                <form id="registrationForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="studentId" class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (5 ‡∏´‡∏•‡∏±‡∏Å)</label>
                            <input type="text" id="studentId" maxlength="5" pattern="[0-9]{5}" inputmode="numeric"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                   placeholder="‡πÄ‡∏ä‡πà‡∏ô 12345" required>
                        </div>
                        
                        <div>
                            <label for="prefix" class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
                            <select id="prefix" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</option>
                                <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
                                <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                                <option value="‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢">‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢</option>
                                <option value="‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á">‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="firstName" class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠</label>
                            <input type="text" id="firstName" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                   placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á" required>
                        </div>
                        
                        <div>
                            <label for="lastName" class="block text-sm font-medium text-gray-700 mb-2">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" id="lastName" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                   placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>
                        </div>
                        
                        <div>
                            <label for="grade" class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label>
                            <select id="grade" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</option>
                                <option value="‡∏°.1">‡∏°.1</option>
                                <option value="‡∏°.2">‡∏°.2</option>
                                <option value="‡∏°.3">‡∏°.3</option>
                                <option value="‡∏°.4">‡∏°.4</option>
                                <option value="‡∏°.5">‡∏°.5</option>
                                <option value="‡∏°.6">‡∏°.6</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="room" class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡πâ‡∏≠‡∏á</label>
                            <select id="room" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button type="submit" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-8 py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-purple-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                            ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
                        </button>
                    </div>
                </form>
            </div>

            <div class="glass-effect rounded-3xl p-8 shadow-2xl mb-8 animate-fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</h2>
                
                <div id="loginSection">
                    <form id="loginForm" class="space-y-4 max-w-md mx-auto">
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                            <input type="email" id="email" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                   placeholder="admin@example.com" required>
                        </div>
                        
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                            <input type="password" id="password" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                   placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
                        </div>
                        
                        <div class="text-center">
                            <button type="submit" class="bg-gradient-to-r from-green-500 to-teal-600 text-white px-6 py-3 rounded-xl font-semibold hover:from-green-600 hover:to-teal-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                                üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                            </button>
                        </div>
                    </form>
                </div>

                <div id="adminPanel" class="hidden">
                    <div class="text-center mb-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üìä ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</h3>
                        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                            ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        <button onclick="exportAllData()" class="bg-blue-500 text-white px-4 py-3 rounded-xl hover:bg-blue-600 transition-colors">
                            üìÑ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                        <button onclick="showFilterOptions()" class="bg-purple-500 text-white px-4 py-3 rounded-xl hover:bg-purple-600 transition-colors">
                            üîç ‡∏Å‡∏£‡∏≠‡∏á/‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á
                        </button>
                        <button onclick="clearAllData()" class="bg-red-500 text-white px-4 py-3 rounded-xl hover:bg-red-600 transition-colors">
                            üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                    </div>

                    <div id="filterOptions" class="hidden mb-6 p-4 bg-gray-100 rounded-xl">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="filterGrade" class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô</label>
                                <select id="filterGrade" onchange="applyFilters()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    <option value="">‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô</option>
                                    <option value="‡∏°.1">‡∏°.1</option>
                                    <option value="‡∏°.2">‡∏°.2</option>
                                    <option value="‡∏°.3">‡∏°.3</option>
                                    <option value="‡∏°.4">‡∏°.4</option>
                                    <option value="‡∏°.5">‡∏°.5</option>
                                    <option value="‡∏°.6">‡∏°.6</option>
                                </select>
                            </div>
                            <div>
                                <label for="filterRoom" class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</label>
                                <select id="filterRoom" onchange="applyFilters()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg p-4 mb-4">
                            <h5 class="font-semibold text-gray-800 mb-3">üìã ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</h5>
                            <div id="filteredPreview" class="space-y-2 max-h-48 overflow-y-auto">
                                </div>
                            <div id="filterCount" class="text-sm text-gray-600 mt-2 font-medium">
                                </div>
                        </div>
                        
                        <div class="text-center">
                            <button onclick="exportFilteredData()" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors">
                                üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-inner">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h4>
                        <div id="studentList" class="space-y-2 max-h-96 overflow-y-auto">
                            </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="text-center mt-12">
            <div class="glass-effect rounded-3xl p-6 shadow-2xl">
                <p class="text-gray-600">¬©Ô∏è 2024 SPT MORAL SCHOOL - ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏° ‡∏™‡∏û‡∏ê. ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á | All Rights Reserved</p>
            </div>
        </footer>
    </div>

    <script>
        // 1. Firebase Configuration - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        const firebaseConfig = {
          apiKey: "AIzaSyDjTCGhEd6WnLn7Q50nj1N_ZCNUPINxGOM",
          authDomain: "comfirm-57d16.firebaseapp.com",
          projectId: "comfirm-57d16",
          storageBucket: "comfirm-57d16.firebasestorage.app",
          messagingSenderId: "147672288587",
          appId: "1:147672288587:web:a284f74f5f8c7441476cce",
          measurementId: "G-JL3DYQYBWJ"
        };

        // 2. Initialize Firebase ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
        let db;
        let auth;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏≤‡∏Å Firebase ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
            document.addEventListener('DOMContentLoaded', () => {
                showNotification("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console (F12)", 'error');
            });
        }
        
        // Notification functions
        let notificationTimeout;
        function showNotification(message, type = 'success') {
            clearTimeout(notificationTimeout);
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            const notificationDiv = notification.querySelector('div');
            
            notificationText.textContent = message;
            
            let bgColor = 'bg-green-500';
            if (type === 'error') {
                bgColor = 'bg-red-500';
            } else if (type === 'warning') {
                bgColor = 'bg-yellow-500';
            }
            
            notificationDiv.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg`;
            
            notification.classList.add('show');
            
            notificationTimeout = setTimeout(() => {
                hideNotification();
            }, 5000);
        }

        function hideNotification() {
            document.getElementById('notification').classList.remove('show');
        }

        // Student Registration
        document.getElementById('registrationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!db) {
                showNotification("‡∏£‡∏∞‡∏ö‡∏ö Firebase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô", 'error');
                return;
            }

            const studentId = document.getElementById('studentId').value.trim();
            const prefix = document.getElementById('prefix').value;
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const grade = document.getElementById('grade').value;
            const room = document.getElementById('room').value;

            if (studentId.length !== 5 || isNaN(parseInt(studentId))) {
                 showNotification('‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 5 ‡∏´‡∏•‡∏±‡∏Å', 'error');
                 return;
            }

            const studentData = {
                studentId: studentId,
                prefix: prefix,
                firstName: firstName,
                lastName: lastName,
                grade: grade,
                room: room,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                // Check if student ID already exists (‡πÉ‡∏ä‡πâ doc(studentId) ‡πÄ‡∏õ‡πá‡∏ô ID)
                const existingStudent = await db.collection('students').doc(studentId).get();
                if (existingStudent.exists) {
                    showNotification('‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'error');
                    return;
                }

                await db.collection('students').doc(studentId).set(studentData); // ‡πÉ‡∏ä‡πâ studentId ‡πÄ‡∏õ‡πá‡∏ô Doc ID
                showNotification(`‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${prefix}${firstName} ${lastName}`);
                document.getElementById('registrationForm').reset();
                
                // Refresh student list if admin is logged in
                if (document.getElementById('adminPanel') && !document.getElementById('adminPanel').classList.contains('hidden')) {
                    loadStudentList();
                }
            } catch (error) {
                console.error('Error adding student:', error);
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Error Code ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô Permission Denied
                if (error.code === 'permission-denied') {
                    showNotification('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firestore Security Rules', 'error');
                } else {
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
                }
            }
        });

        // Admin Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!auth) {
                showNotification("‡∏£‡∏∞‡∏ö‡∏ö Firebase Auth ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô", 'error');
                return;
            }

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                await auth.signInWithEmailAndPassword(email, password);
                // showAdminPanel ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ú‡πà‡∏≤‡∏ô auth.onAuthStateChanged
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≤‡∏î‡πÄ‡∏î‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•
                } else {
                    errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                }
                showNotification(errorMessage, 'error');
            }
        });

        function showAdminPanel() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            showNotification('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            loadStudentList();
        }

        function logout() {
            auth.signOut().then(() => {
                document.getElementById('loginSection').classList.remove('hidden');
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('filterOptions').classList.add('hidden');
                showNotification('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
            }).catch(error => {
                console.error("Logout error:", error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', 'error');
            });
        }

        // Load student list (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
        async function loadStudentList() {
            if (!db) return;
            try {
                const snapshot = await db.collection('students').orderBy('timestamp', 'desc').limit(20).get(); 
                const studentList = document.getElementById('studentList');
                studentList.innerHTML = '';

                if (snapshot.empty) {
                    studentList.innerHTML = '<p class="text-gray-500 text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p>';
                    return;
                }

                snapshot.forEach((doc) => {
                    const student = doc.data();
                    const studentDiv = document.createElement('div');
                    studentDiv.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg shadow-sm hover:bg-gray-100 transition-colors';
                    studentDiv.innerHTML = `
                        <div>
                            <span class="font-semibold">${student.studentId}</span> - 
                            ${student.prefix}${student.firstName} ${student.lastName} 
                            (<span class="text-blue-600">${student.grade}/${student.room}</span>)
                        </div>
                        <button onclick="deleteStudent('${doc.id}')" 
                                class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors text-sm ml-2">
                            ‡∏•‡∏ö
                        </button>
                    `;
                    studentList.appendChild(studentDiv);
                });
            } catch (error) {
                console.error('Error loading students:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'error');
            }
        }

        // Delete student
        async function deleteStudent(studentId) {
            if (!db) return;
            if (confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ID: ${studentId} ?`)) {
                try {
                    await db.collection('students').doc(studentId).delete();
                    showNotification('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    loadStudentList();
                } catch (error) {
                    console.error('Error deleting student:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            }
        }

        // Clear all data
        async function clearAllData() {
            if (!db) return;
            if (confirm('‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!')) {
                try {
                    const snapshot = await db.collection('students').get();
                    if (snapshot.empty) {
                        showNotification('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏•‡∏ö', 'warning');
                        return;
                    }

                    const batch = db.batch();
                    
                    snapshot.docs.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    
                    await batch.commit();
                    showNotification(`‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${snapshot.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                    loadStudentList();
                } catch (error) {
                    console.error('Error clearing data:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', 'error');
                }
            }
        }

        // Export/Filter functions
        function showFilterOptions() {
            const filterOptionsDiv = document.getElementById('filterOptions');
            if (filterOptionsDiv.classList.contains('hidden')) {
                 filterOptionsDiv.classList.remove('hidden');
                 document.getElementById('filterGrade').value = '';
                 document.getElementById('filterRoom').value = '';
                 applyFilters(); 
            } else {
                 filterOptionsDiv.classList.add('hidden');
            }
        }

        async function applyFilters() {
            if (!db) return;
            const grade = document.getElementById('filterGrade').value;
            const room = document.getElementById('filterRoom').value;
            
            try {
                let query = db.collection('students');
                
                if (grade) {
                    query = query.where('grade', '==', grade);
                }
                if (room) {
                    query = query.where('room', '==', room);
                }
                
                query = query.orderBy('grade').orderBy('room').orderBy('studentId'); 
                
                const snapshot = await query.get();
                const filteredPreview = document.getElementById('filteredPreview');
                const filterCount = document.getElementById('filterCount');
                
                filteredPreview.innerHTML = '';
                
                if (snapshot.empty) {
                    filteredPreview.innerHTML = '<p class="text-gray-500 text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';
                    filterCount.textContent = '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: 0 ‡∏Ñ‡∏ô';
                    return;
                }
                
                let count = 0;
                snapshot.forEach((doc) => {
                    const student = doc.data();
                    count++;
                    
                    const studentDiv = document.createElement('div');
                    studentDiv.className = 'flex justify-between items-center p-2 bg-gray-50 rounded text-sm';
                    studentDiv.innerHTML = `
                        <div>
                            <span class="font-medium">${student.studentId}</span> - 
                            ${student.prefix}${student.firstName} ${student.lastName} 
                            (${student.grade}/${student.room})
                        </div>
                    `;
                    filteredPreview.appendChild(studentDiv);
                });
                
                filterCount.textContent = `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${count} ‡∏Ñ‡∏ô`;
                
            } catch (error) {
                console.error('Error applying filters:', error);
                document.getElementById('filteredPreview').innerHTML = '<p class="text-red-500 text-center">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            }
        }

        async function exportAllData() {
            if (!db) return;
            try {
                const snapshot = await db.collection('students').orderBy('grade').orderBy('room').orderBy('studentId').get();
                if (snapshot.empty) {
                     showNotification('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å', 'warning');
                     return;
                }
                const csvData = generateCSV(snapshot.docs);
                downloadCSV(csvData, 'students_all_data.csv');
                showNotification(`‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${snapshot.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            } catch (error) {
                console.error('Error exporting data:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            }
        }

        async function exportFilteredData() {
            if (!db) return;
            const grade = document.getElementById('filterGrade').value;
            const room = document.getElementById('filterRoom').value;
            
            try {
                let query = db.collection('students');
                
                if (grade) {
                    query = query.where('grade', '==', grade);
                }
                if (room) {
                    query = query.where('room', '==', room);
                }
                
                const snapshot = await query.orderBy('studentId').get();

                if (snapshot.empty) {
                     showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å', 'warning');
                     return;
                }
                
                const csvData = generateCSV(snapshot.docs);
                
                let filename = 'students';
                if (grade) filename += `_${grade}`;
                if (room) filename += `_room${room}`;
                filename += '.csv';
                
                downloadCSV(csvData, filename);
                showNotification(`‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${snapshot.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                document.getElementById('filterOptions').classList.add('hidden');
            } catch (error) {
                console.error('Error exporting filtered data:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            }
        }

        // ‡πÉ‡∏ä‡πâ Tab-Separated Values (TSV) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
        function generateCSV(docs) {
            const separator = '\t'; 
            const headers = ['‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß', '‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤', '‡∏ä‡∏∑‡πà‡∏≠', '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô', '‡∏´‡πâ‡∏≠‡∏á', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'];
            let csv = headers.join(separator) + '\n';
            
            docs.forEach((doc) => {
                const student = doc.data();
                
                const timestamp = student.timestamp && student.timestamp.toDate ? 
                                  student.timestamp.toDate().toLocaleString('th-TH') : 
                                  'N/A';
                                  
                const sanitize = (text) => {
                    if (typeof text !== 'string') text = String(text);
                    return text.replace(/[\n\r\t]/g, ' ').trim(); // ‡∏•‡∏ö Tab ‡πÅ‡∏•‡∏∞ Newline
                }
                
                const row = [
                    sanitize(student.studentId),
                    sanitize(student.prefix),
                    sanitize(student.firstName),
                    sanitize(student.lastName),
                    sanitize(student.grade),
                    sanitize(student.room),
                    sanitize(timestamp)
                ];
                csv += row.join(separator) + '\n';
            });
            
            return csv;
        }

        // Download function (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Unicode/UTF-8 BOM)
        function downloadCSV(csvData, filename) {
            const blob = new Blob(['\ufeff' + csvData], { type: 'text/csv;charset=utf-8;' }); 
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Check auth state
        auth.onAuthStateChanged((user) => {
            if (user) {
                showAdminPanel();
            } else {
                 document.getElementById('loginSection').classList.remove('hidden');
                 document.getElementById('adminPanel').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
